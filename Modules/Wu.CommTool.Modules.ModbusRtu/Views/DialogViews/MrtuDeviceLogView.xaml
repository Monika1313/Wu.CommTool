<UserControl x:Class="Wu.CommTool.Modules.ModbusRtu.Views.DialogViews.MrtuDeviceLogView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:core="Wu.CommTool.Core"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:ddvm="clr-namespace:Wu.CommTool.Modules.ModbusRtu.ViewModels.DialogViewModels.DialogDesignViewModels"
             xmlns:hc="https://handyorg.github.io/handycontrol"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:local="clr-namespace:Wu.CommTool.Modules.ModbusRtu.Views.DialogViews"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:md="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:models="clr-namespace:Wu.CommTool.Modules.ModbusRtu.Models"
             xmlns:prism="http://prismlibrary.com/"
             xmlns:wu="https://github.com/Monika1313/Wu"
             d:DataContext="{x:Static ddvm:MrtuDeviceLogDesignViewModel.Instance}"
             d:Height="200"
             d:Width="300"
             prism:ViewModelLocator.AutoWireViewModel="True"
             mc:Ignorable="d">
    <DockPanel Background="White">
        <Grid DockPanel.Dock="Top">
            <TextBlock HorizontalAlignment="Center"
                       Style="{StaticResource TitleTextBlock}"
                       Text="{Binding CurrentDevice.Name}" />
            <DockPanel LastChildFill="False">
                <!--  暂停显示按钮  -->
                <Button Width="30"
                        Height="{Binding RelativeSource={RelativeSource self}, Path=Width}"
                        Margin="5"
                        HorizontalAlignment="Left"
                        Command="{Binding CurrentDevice.PauseCommand}"
                        Cursor="Hand"
                        DockPanel.Dock="Left">
                    <md:PackIcon Width="24" Height="24">
                        <md:PackIcon.Style>
                            <Style TargetType="md:PackIcon">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding CurrentDevice.IsPause}" Value="true">
                                        <Setter Property="Kind" Value="PlayPause" />
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding CurrentDevice.IsPause}" Value="false">
                                        <Setter Property="Kind" Value="Pause" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </md:PackIcon.Style>
                    </md:PackIcon>
                    <Button.Style>
                        <Style BasedOn="{StaticResource MaterialDesignFloatingActionMiniButton}" TargetType="Button">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding CurrentDevice.IsPause}" Value="true">
                                    <Setter Property="Foreground" Value="{StaticResource Green_Foreground}" />
                                    <Setter Property="Background" Value="{StaticResource Green_Background}" />
                                    <Setter Property="BorderBrush" Value="{StaticResource Green_BorderBrush}" />
                                    <Setter Property="hc:Poptip.Content" Value="启用界面更新" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding CurrentDevice.IsPause}" Value="false">
                                    <Setter Property="Foreground" Value="{StaticResource Yellow_Foreground}" />
                                    <Setter Property="Background" Value="{StaticResource Yellow_Background}" />
                                    <Setter Property="BorderBrush" Value="{StaticResource Yellow_BorderBrush}" />
                                    <Setter Property="hc:Poptip.Content" Value="暂停界面更新" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
                <!--  清空消息按钮  -->
                <Button Width="30"
                        Height="{Binding RelativeSource={RelativeSource self}, Path=Width}"
                        Margin="5"
                        hc:Poptip.Content="清空消息"
                        Command="{Binding CurrentDevice.MessageClearCommand}"
                        Content="{md:PackIcon Kind=Delete}"
                        DockPanel.Dock="Left"
                        Style="{StaticResource Red_CircleButton}" />
            </DockPanel>
        </Grid>

        <ContentControl Margin="4,0"
                        DockPanel.Dock="Top"
                        Style="{StaticResource Effect2Control}">
            <hc:ScrollViewer wu:ScrollViewerExtensions.AlwaysScrollToEnd="True" IsInertiaEnabled="True">
                <ItemsControl Background="Transparent" ItemsSource="{Binding ModbusRtuModel.Messages, Mode=OneTime, IsAsync=True}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <VirtualizingStackPanel VirtualizingPanel.CacheLength="2"
                                                    VirtualizingPanel.CacheLengthUnit="Page"
                                                    VirtualizingPanel.IsVirtualizingWhenGrouping="True"
                                                    VirtualizingPanel.VirtualizationMode="Recycling" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>

                    <ItemsControl.Resources>
                        <DataTemplate DataType="{x:Type core:MessageData}">
                            <Border Style="{StaticResource MessageBorder}" Tag="{Binding DataContext, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}">
                                <WrapPanel Orientation="Horizontal">
                                    <TextBlock Margin="3"
                                               VerticalAlignment="Center"
                                               Style="{StaticResource MessageTextBlock}"
                                               Text="{Binding Time, StringFormat={}{0:yyyy-MM-dd HH:mm:ss.fff}}" />
                                    <TextBlock Margin="5,0"
                                               VerticalAlignment="Center"
                                               Style="{StaticResource MessageTextBlock}"
                                               Text="{Binding Type}" />
                                    <TextBox VerticalAlignment="Center"
                                             FontSize="12"
                                             FontWeight="Bold"
                                             IsReadOnly="True"
                                             Style="{StaticResource MessageTextBox}"
                                             Text="{Binding Content}"
                                             TextWrapping="Wrap" />
                                    <!--<TextBlock VerticalAlignment="Center"
                                       FontSize="12"
                                       FontWeight="Bold"
                                       Style="{StaticResource MessageTextBlock}"
                                       Text="{Binding Content}"
                                       TextWrapping="Wrap" />-->
                                </WrapPanel>
                            </Border>
                        </DataTemplate>

                        <DataTemplate DataType="{x:Type models:ModbusRtuMessageData}">
                            <Border Style="{StaticResource MessageBorder}" Tag="{Binding DataContext, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}">
                                <i:Interaction.Triggers>
                                    <i:EventTrigger EventName="MouseLeftButtonUp">
                                        <i:InvokeCommandAction Command="{Binding DataContext.OpenAnalyzeFrameViewCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type UserControl}}}" CommandParameter="{Binding}" />
                                    </i:EventTrigger>
                                </i:Interaction.Triggers>
                                <Border.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Command="{Binding Path=PlacementTarget.Tag.CopyModbusRtuFrameCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ContextMenu}}}"
                                                  CommandParameter="{Binding}"
                                                  Header="复制Modbus数据帧"
                                                  Visibility="{Binding ModbusRtuFrame, Converter={core:Null2Collapsed}}" />
                                        <MenuItem Command="{Binding Path=PlacementTarget.Tag.OpenAnalyzeFrameViewCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ContextMenu}}}"
                                                  CommandParameter="{Binding}"
                                                  Header="解析数据帧"
                                                  Visibility="{Binding ModbusRtuFrame, Converter={core:Null2Collapsed}}" />
                                    </ContextMenu>
                                </Border.ContextMenu>
                                <WrapPanel Orientation="Horizontal">
                                    <TextBlock Margin="3"
                                               VerticalAlignment="Center"
                                               Style="{StaticResource MessageTextBlock}"
                                               Text="{Binding Time, StringFormat={}{0:yyyy-MM-dd HH:mm:ss.fff}}" />
                                    <TextBlock Margin="5,0"
                                               VerticalAlignment="Center"
                                               Style="{StaticResource MessageTextBlock}"
                                               Text="{Binding Type}" />
                                    <ItemsControl Background="Transparent"
                                                  ItemsSource="{Binding MessageSubContents}"
                                                  Visibility="{Binding MessageSubContents.Count, Converter={wu:Zero2Collapsed}}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel VerticalAlignment="Center" Orientation="Horizontal" />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Margin="3,0,3,0"
                                                           VerticalAlignment="Center"
                                                           FontWeight="Bold"
                                                           Style="{StaticResource ModbusRtuMessageTextBlock}"
                                                           Text="{Binding Content}"
                                                           TextWrapping="Wrap" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </WrapPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.Resources>
                </ItemsControl>
            </hc:ScrollViewer>
        </ContentControl>
    </DockPanel>
</UserControl>
